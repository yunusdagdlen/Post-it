
#!/usr/bin/python3
# -*- coding: utf-8 -*-
# Copyright (C) 2023 Sarp Cyber Security - All Rights Reserved
# Unauthorized copying of this file, via any medium is strictly prohibited
# Proprietary and confidential

import json
import requests



class MassdataVulnerability:
    VULNERABILITY_LATEST_URL = 'latest?key={}'
    VULNERABILITY_CVE_SEARCH_URL = 'search/cve?key={}'
    VULNERABILITY_APPLICATION_VULNERABILITY_LIST_URL = 'application/vulnerabilities?key={}'
    VULNERABILITY_CPE_VULNERABILITY_LIST_URL = 'application/vulnerabilities/cpe?key={}'
    VULNERABILITY_GET_CVE_DETAILS_URL = 'cve/{}?key={}'
    VULNERABILITY_GUESS_CPE_URL = 'cpe/guess?key={}'
    VULNERABILITY_STATISTICS_URL = 'statistics?key={}'
    VULNERABILITY_GET_EXPLOITS_URL = 'exploit/{}?key={}'
    VULNERABILITY_ADD_SOCRADAR_BLOG_URL = 'cve/insert_socradar_blog?key={}'
    VULNERABILITY_GET_CVE_LIST_CVSS_SCORE = 'cve/cve_list_info?key={}'
    VULNERABILITY_REMOVE_SOCRADAR_BLOG_URL = 'cve/remove_socradar_blog?key={}'
    VULNERABILITY_INSERT_CVE_URL = 'cve/insert_cve?key={}'
    VULNERABILITY_INSERT_EXPLOIT_URL = 'exploit/insert_exploit?key={}'
    VULNERABILITY_CWE_LIST_URL = 'cwe/get_cwe_list?key={}'
    VULNERABILITY_GUESS_VENDOR_URL = 'guess_vendor?q={}&key={}'
    VULNERABILITY_GUESS_PRODUCT_URL = 'guess_prod?vendor={}&q={}&key={}'
    VULNERABILITY_GUESS_VERSION_URL = 'guess_version?vendor={}&product={}&q={}&key={}'
    VULNERABILITY_GET_CPE_URL = 'get_product_cpe_list?vendor={}&product={}&version={}&key={}'
    VULNERABILITY_ADD_CVE_TAGS_URL = 'cve/add_cve_tag?key={}'
    VULNERABILITY_UPDATE_CVE_URL = 'cve/update_cve?key={}'
    VULNERABILITY_PROMOTO_CVE_TRENDS = 'cve/promoto_cve2trends?key={}&cveid={}'
    VULNERABILITY_UNPROMOTO_CVE_TRENDS = 'cve/unpromoto_cve_from_trends?key={}&cveid={}'
    VULNERABILITY_DBD_STATS_URL = 'cve/get_cve_statistics?key={}&cveid={}&scope={}&date={}'
    VULNERABILITY_CVE_TRENDS_URL = 'get_daily_cve_trends?key={}&date={}&scope={}'
    VULNERABILITY_HIGH_AUDIENCE_CVE_URL = 'cve/get_high_audience_cve_list?key={}'
    VULNERABILITY_INSERT_CVE_DORK_URL = 'cve/insert_cve_dork?key={}'
    VULNERABILITY_DELETE_CVE_DORK_URL = 'cve/delete_cve_dork?key={}'
    VULNERABILITY_GET_CVE_DORKS = 'cve/get_cve_dorks?key={}'
    VULNERABILITY_GET_CVE_DORK_IOCS = 'cve/get_cve_dorks_iocs?key={}&cveid={}'
    VULNERABILITY_GET_CVE_DORK_COUNTRY_STATS = 'cve/get_cve_country_statists?key={}&cveid={}'

    def __init__(self):
        self.root_url = 'https://massdata.socradar.com/vulnerability/'
        #self.root_url = 'http://127.0.0.1:3142/vulnerability/'
        self.api_key = 'ZGVjMjAwY2EwOTg3NzRkZjA4NTA5NWNi'
        #self.config = config
        #self.logger = logger
        self.head = {'Content-type': 'application/json', 'Accept': 'application/json'}

    def get_cve_trends(self, date, scope='cve_trends_weekly'):
        stats_data = {}
        try:
            cve_trends_response = requests.get(
                f"{self.root_url}{self.VULNERABILITY_CVE_TRENDS_URL}".format(self.api_key, date, scope),
                headers=self.head)

            stats_data = json.loads(cve_trends_response.text)
        except:
            pass
            #if self.logger:
            #self.logger.exception("error during querying cve stats from vulnerability")
        return stats_data

    def get_cve_details(self, cve_id):
        vulnerabilities_response = {}
        vulnerabilities_req_response = None
        try:
            cve_id = cve_id.upper()
            vulnerabilities_req_response = requests.get(
                f"{self.root_url}{self.VULNERABILITY_GET_CVE_DETAILS_URL}".format(cve_id, self.api_key),
                headers=self.head, timeout=60)
            vulnerabilities_response = json.loads(vulnerabilities_req_response.text)
        except:
            pass
            # if self.logger:
            #     self.logger.exception('Exception at search get cve details service')
            #     if vulnerabilities_req_response:
            #         self.logger.error(vulnerabilities_req_response.text)

        return vulnerabilities_response